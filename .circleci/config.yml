version: 2.1
jobs:
  build-server:
    docker:
      - image: rustlang/rust:nightly
    steps:
      - checkout
      - run:
          name: Rustup
          command: rustup toolchain install nightly; rustup default nightly; rustup target add x86_64-unknown-linux-musl
      - run:
          name: Version information
          command: rustc --version; cargo --version; rustup --version
      - run:
          name: Build
          command: cd server; cargo build --target x86_64-unknown-linux-musl --release
      - persist_to_workspace:
          root: server
          paths:
            - target

  deploy-server:
    docker:
      - image: circleci/python:2.7-jessie
    steps:
      - attach_workspace:
          at: /tmp/recipes-server
      - run:
          name: Install awscli
          command: sudo pip install awscli
      - run:
          name: Deploy to S3
          command: aws s3 sync /tmp/recipes-server/ s3://recipes.elliotdavies.co.uk/ --delete
          # command: tar -czf release.tar.gz /tmp/recipes-server/target/release; scp release.tar.gz ec2-user@ec2-35-177-170-145.eu-west-2.compute.amazonaws.com:/home/ec2-user

  build-client:
    docker:
      - image: node:lts
    steps:
      - checkout
      - run:
          name: Version information
          command: node --version; yarn --version
      - run:
          name: Install dependencies
          command: cd client; yarn
      - run:
          name: Build
          command: cd client; yarn build

workflows:
  build-deploy:
    jobs:
      - build-server
      - build-client
      - deploy-server:
          requires:
            - build-server
          filters:
            branches:
              only: master
